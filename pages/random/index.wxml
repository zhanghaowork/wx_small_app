<view class="page">
  <view class="section-title">æ¯”èµ›ä¿¡æ¯</view>
  <view class="card form-card">
    <view class="row">
      <text class="label">æ ‡é¢˜</text>
      <input class="value-input" placeholder="è¾“å…¥æ¯”èµ›æ ‡é¢˜" value="{{title}}" bindinput="onTitleInput" />
    </view>
    <view class="divider"></view>
    <view class="row">
      <text class="label">æ¯”èµ›æ—¥æœŸ</text>
      <picker mode="date" value="{{matchDate}}" bindchange="onDateChange">
        <view class="picker-text">{{matchDate || 'é€‰æ‹©æ¯”èµ›æ—¥æœŸ'}}</view>
      </picker>
    </view>
  </view>

  <view class="section-title">å‚èµ›äººå‘˜ï¼ˆ4-8äººï¼‰</view>
  <view class="card player-card">
    <view class="player-row" wx:for="{{players}}" wx:key="id">
      <text class="order">{{index + 1}}å·é€‰æ‰‹</text>
      <text class="gender {{item.gender === 'M' ? 'male' : 'female'}}" bindtap="toggleGender" data-index="{{index}}">{{item.gender === 'M' ? 'ç”·' : 'å¥³'}}</text>
      <input class="player-input" placeholder="è¾“å…¥å‚èµ›é€‰æ‰‹å§“å" value="{{item.name}}" data-index="{{index}}" bindinput="onPlayerNameInput" />
      <button class="delete-btn" size="mini" data-index="{{index}}" bindtap="removePlayer">åˆ é™¤</button>
    </view>

    <view class="actions">
      <button class="batch-btn" bindtap="showBatchInput">æŒ‰é¾™æ‰¹é‡å¯¼å…¥</button>
      <button class="add-btn" bindtap="addPlayer">æ·»åŠ é€‰æ‰‹</button>
    </view>
  </view>

  <view class="section-title">åœºæ¬¡è§„åˆ™</view>
  <view class="card rounds-card">
    <view class="rounds-tip">è§„åˆ™ï¼šæ¯”èµ›åœºæ•° = A*(A-1)/4ï¼›6äºº/7äººæŒ‰ç‰¹ä¾‹è§„åˆ™</view>
    <view class="rule-list">
      <view
        wx:for="{{scheduleOptions}}"
        wx:key="rounds"
        class="rule-item {{selectedOptionIndex === index ? 'rule-item-active' : ''}}"
        data-index="{{index}}"
        bindtap="selectRule"
      >{{item.text}}</view>
    </view>
  </view>

  <view class="error" wx:if="{{errorText}}">{{errorText}}</view>

  <view class="batch-panel" wx:if="{{batchInputVisible}}">
    <view class="panel-mask" bindtap="hideBatchInput"></view>
    <view class="panel-body">
      <view class="panel-title">æ‰¹é‡å¯¼å…¥é€‰æ‰‹</view>
      <textarea class="panel-textarea" placeholder="è¾“å…¥æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªåå­—ï¼Œæˆ–ç”¨é€—å·åˆ†éš”" value="{{batchText}}" bindinput="onBatchTextInput"></textarea>
      <view class="panel-actions">
        <button class="panel-cancel" bindtap="hideBatchInput">å–æ¶ˆ</button>
        <button class="panel-ok" bindtap="applyBatchInput">ç¡®è®¤å¯¼å…¥</button>
      </view>
    </view>
  </view>

  <view class="schedule" wx:if="{{schedule.length > 0}}">
    <view class="section-title">èµ›ç¨‹ç»“æœ</view>
    <view class="summary">
      <text>æ¯äºº{{summary.perPlayer}}åœº</text>
      <text>å…±{{summary.rounds}}åœº</text>
      <text>é‡å¤é˜Ÿå‹{{summary.teammateRepeats}}</text>
      <text>é‡å¤å¯¹æ‰‹{{summary.opponentRepeats}}</text>
    </view>

    <view class="score-toolbar card">
      <text class="score-tip">ç‚¹å‡»æ¯”åˆ†å¯ä»¥ä¿®æ”¹</text>
      <view class="score-actions">
        <button class="toolbar-btn print-btn" bindtap="handlePrint">æ‰“å°</button>
        <button class="toolbar-btn share-btn" bindtap="handleShare">è½¬å‘</button>
      </view>
    </view>

    <view class="card score-card" wx:for="{{schedule}}" wx:key="round">
      <view class="match-head">ç¬¬ {{item.round}} å±€</view>
      <view class="score-line">
        <view class="team-col">
          <text class="player-tag">{{item.team1[0]}}</text>
          <text class="player-tag">{{item.team1[1]}}</text>
        </view>
        <view class="score-center">
          <input class="score-input" type="number" data-index="{{index}}" data-team="1" value="{{item.score1}}" bindinput="onScoreInput" />
          <text class="vs-big">VS</text>
          <input class="score-input" type="number" data-index="{{index}}" data-team="2" value="{{item.score2}}" bindinput="onScoreInput" />
        </view>
        <view class="team-col">
          <text class="player-tag">{{item.team2[0]}}</text>
          <text class="player-tag">{{item.team2[1]}}</text>
        </view>
      </view>
      <view class="rest" wx:if="{{item.rests.length > 0}}">è½®ä¼‘ï¼š{{item.rests.join('ã€')}}</view>
    </view>
  </view>

  <view class="settlement" wx:if="{{resultReady}}">
    <view class="section-title">ç»“ç®—æ’åï¼ˆå·²å½•å…¥{{totalScoredMatches}}åœºï¼‰</view>
    <view class="card rank-card">
      <view class="rank-header">
        <text class="rank-col rank-col-rank">æ’å</text>
        <text class="rank-col rank-col-name">é€‰æ‰‹</text>
        <text class="rank-col">èƒœåœº</text>
        <text class="rank-col">å‡€èƒœ</text>
        <text class="rank-col">èƒœç‡</text>
      </view>
      <view class="rank-row {{index === 0 ? 'rank-top1' : (index === 1 ? 'rank-top2' : (index === 2 ? 'rank-top3' : ''))}}" wx:for="{{ranking}}" wx:key="name">
        <view class="rank-col rank-col-rank rank-rank-wrap">
          <text class="medal" wx:if="{{index === 0}}">ğŸ¥‡</text>
          <text class="medal" wx:if="{{index === 1}}">ğŸ¥ˆ</text>
          <text class="medal" wx:if="{{index === 2}}">ğŸ¥‰</text>
          <text class="rank-no">{{index + 1}}</text>
        </view>
        <text class="rank-col rank-col-name">{{item.name}}</text>
        <text class="rank-col rank-num">{{item.wins}}</text>
        <text class="rank-col rank-num">{{item.diff}}</text>
        <text class="rank-col rank-num">{{item.winRate}}%</text>
      </view>
    </view>
  </view>

  <view class="bottom-safe"></view>
  <view class="fixed-footer">
    <button class="generate-btn" bindtap="onPrimaryAction">{{schedule.length > 0 ? 'ç»“æŸæ¯”èµ›' : 'ç”Ÿæˆæ¯”èµ›'}}</button>
  </view>
</view>

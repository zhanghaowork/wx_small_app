<view class="page">
  <view class="section-title">比赛信息</view>
  <view class="card form-card">
    <view class="row">
      <text class="label">标题</text>
      <input class="value-input" placeholder="输入比赛标题" value="{{title}}" bindinput="onTitleInput" />
    </view>
    <view class="divider"></view>
    <view class="row">
      <text class="label">比赛日期</text>
      <picker mode="date" value="{{matchDate}}" bindchange="onDateChange">
        <view class="picker-text">{{matchDate || '选择比赛日期'}}</view>
      </picker>
    </view>
  </view>

  <view class="section-title">参赛人员（4-8人）</view>
  <view class="card player-card">
    <view class="player-row" wx:for="{{players}}" wx:key="id">
      <text class="order">{{index + 1}}号选手</text>
      <text class="gender {{item.gender === 'M' ? 'male' : 'female'}}" bindtap="toggleGender" data-index="{{index}}">{{item.gender === 'M' ? '男' : '女'}}</text>
      <input class="player-input" placeholder="输入参赛选手姓名" value="{{item.name}}" data-index="{{index}}" bindinput="onPlayerNameInput" />
      <button class="delete-btn" size="mini" data-index="{{index}}" bindtap="removePlayer">删除</button>
    </view>

    <view class="actions">
      <button class="batch-btn" bindtap="showBatchInput">按龙批量导入</button>
      <button class="add-btn" bindtap="addPlayer">添加选手</button>
    </view>
  </view>

  <view class="section-title">场次规则</view>
  <view class="card rounds-card">
    <view class="rounds-tip">规则：比赛场数 = A*(A-1)/4；6人/7人按特例规则</view>
    <view class="rule-list">
      <view
        wx:for="{{scheduleOptions}}"
        wx:key="rounds"
        class="rule-item {{selectedOptionIndex === index ? 'rule-item-active' : ''}}"
        data-index="{{index}}"
        bindtap="selectRule"
      >{{item.text}}</view>
    </view>
  </view>

  <view class="error" wx:if="{{errorText}}">{{errorText}}</view>

  <view class="batch-panel" wx:if="{{batchInputVisible}}">
    <view class="panel-mask" bindtap="hideBatchInput"></view>
    <view class="panel-body">
      <view class="panel-title">批量导入选手</view>
      <textarea class="panel-textarea" placeholder="输入格式：每行一个名字，或用逗号分隔" value="{{batchText}}" bindinput="onBatchTextInput"></textarea>
      <view class="panel-actions">
        <button class="panel-cancel" bindtap="hideBatchInput">取消</button>
        <button class="panel-ok" bindtap="applyBatchInput">确认导入</button>
      </view>
    </view>
  </view>

  <view class="schedule" wx:if="{{schedule.length > 0}}">
    <view class="section-title">赛程结果</view>
    <view class="summary">
      <text>每人{{summary.perPlayer}}场</text>
      <text>共{{summary.rounds}}场</text>
      <text>重复队友{{summary.teammateRepeats}}</text>
      <text>重复对手{{summary.opponentRepeats}}</text>
    </view>

    <view class="card match-card" wx:for="{{schedule}}" wx:key="round">
      <view class="match-head">第 {{item.round}} 场</view>
      <view class="teams">
        <text>{{item.team1[0]}} / {{item.team1[1]}}</text>
        <text class="vs">VS</text>
        <text>{{item.team2[0]}} / {{item.team2[1]}}</text>
      </view>
      <view class="rest" wx:if="{{item.rests.length > 0}}">轮休：{{item.rests.join('、')}}</view>
    </view>
  </view>

  <view class="bottom-safe"></view>
  <view class="fixed-footer">
    <button class="generate-btn" bindtap="generateCompetition">生成比赛</button>
  </view>
</view>
